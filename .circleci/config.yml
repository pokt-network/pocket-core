# Configuration file Version: 2.1.
version: 2.1

executors:
  core-executor:
      docker:
        - image: circleci/golang:1.11
          environment:
            GO111MODULE: "on"

# Commands are sets of steps that can be reutilized 
commands:
  build-pocket-image:
    steps:
      - checkout
      # specify any bash command here prefixed with `run: `
      - run: ./deps.sh
      - run: go build cmd/pocket_core/main.go
      - run: go test ./tests/unit/...
      - run: go test ./tests/bdd/...
  # Proceeds to scan pocket-core image to see if it finds vulnerabilities in it.
  local_image_scan:
    steps:
       - setup_remote_docker
       - checkout
       - run: GO111MODULE= on
       - run: /bin/bash deps.sh       
       - run: docker build -t "${CIRCLE_PROJECT_REPONAME}:ci" -f ./Dockerfile .
       - anchore/analyze_local_image:
          image_name: ${CIRCLE_PROJECT_REPONAME}:ci
          dockerfile_path: ./Dockerfile
          timeout: '600'
       - anchore/parse_reports
       - store_artifacts:
           path: anchore-reports
  # Sends a slack notification if build fails
  # For more information on Slack Orb: https://github.com/CircleCI-Public/slack-orb
  slack-notification:
    steps:
      - run: exit 0
      - slack/status:
          fail_only: true
          webhook: "https://hooks.slack.com/services/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"
          failure_message: "Failed: ${CIRCLE_JOB} job has failed!"

jobs:
  build:
    executor: core-executor
    steps:
      - build-pocket-image
      - slack-notification
    working_directory: /go/src/github.com/pokt-network/pocket-core
  image_scan:
    executor: anchore/anchore_engine
    steps:
      - local_image_scan
      - slack-notification

orbs:
  anchore: anchore/anchore-engine@1.6.0
  slack: circleci/slack@3.4.0

workflows:
  build_and_scan:
    jobs:
      - build
      - image_scan:
          requires:
            - build